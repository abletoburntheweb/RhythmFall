[gd_scene load_steps=2 format=3 uid="uid://cohedptdwspul"]

[sub_resource type="GDScript" id="GDScript_usftd"]
script/source = "# scenes/profile/accuracy_chart.gd
class_name AccuracyChart
extends Control

@onready var accuracy_chart_line: Line2D = $ChartBackground/AccuracyChartLine
@onready var accuracy_chart_points: Control = $ChartBackground/AccuracyChartPoints
@onready var chart_background: ColorRect = $ChartBackground
@onready var tooltip_label: RichTextLabel = get_node_or_null(\"ChartBackground/TooltipLabel\") as RichTextLabel

var session_history_manager = null

func set_session_history_manager(manager):
	session_history_manager = manager

func update_chart():
	if session_history_manager == null:
		printerr(\"AccuracyChart: SessionHistoryManager не установлен!\")
		_clear_chart()
		return

	var history = session_history_manager.get_history()
	if history.size() == 0:
		print(\"AccuracyChart: Нет истории сессий для отображения.\")
		_clear_chart()
		return

	_clear_points()

	var start_index = max(0, history.size() - 20)
	var relevant_history = history.slice(start_index, history.size())

	var points = []
	for i in range(20):
		var session = null
		if i < relevant_history.size():
			session = relevant_history[i]
		else:
			session = {
				\"accuracy\": 0.0,
				\"grade_color\": {\"r\": 0.5, \"g\": 0.5, \"b\": 0.5, \"a\": 1.0} 
			}

		var accuracy = session.get(\"accuracy\", 0.0)
		var bg_width = chart_background.size.x
		var bg_height = chart_background.size.y
		var x = 20 + i * ((bg_width - 40) / 19.0) if 19 > 0 else 20
		var y = bg_height - (accuracy / 100.0) * bg_height
		points.append(Vector2(x, y))
	accuracy_chart_line.points = points

	for i in range(20):
		var session = null
		var tooltip_text = \"Н/Д - Н/Д (0.00%)\"
		if i < relevant_history.size():
			session = relevant_history[i]
			var accuracy = session.get(\"accuracy\", 0.0)
			var artist = session.get(\"artist\", \"Unknown\")
			var title = session.get(\"title\", \"Unknown Track\")
			tooltip_text = \"%s - %s\\n(%.2f%%)\" % [artist, title, accuracy]
		else:
			var accuracy = session.get(\"accuracy\", 0.0) if session else 0.0
			tooltip_text = \"Н/Д - Н/Д\\n(%.2f%%)\" % accuracy

		var grade_color_dict = session.get(\"grade_color\", {\"r\": 1.0, \"g\": 1.0, \"b\": 1.0, \"a\": 1.0}) if session else {\"r\": 0.5, \"g\": 0.5, \"b\": 0.5, \"a\": 1.0}
		var color = Color(grade_color_dict[\"r\"], grade_color_dict[\"g\"], grade_color_dict[\"b\"], grade_color_dict[\"a\"])

		var bg_width = chart_background.size.x
		var bg_height = chart_background.size.y
		var x = 20 + i * ((bg_width - 40) / 19.0) if 19 > 0 else 20
		var y = bg_height - (session.get(\"accuracy\", 0.0) / 100.0) * bg_height if session else bg_height

		var point_position = Vector2(x, y)

		var point_control_script = load(\"res://scenes/profile/chart_point.gd\")
		var point_control = point_control_script.new()

		point_control.set_tooltip_text(tooltip_text)

		point_control.point_color = color
		point_control.point_radius = 6.0
		point_control.border_width = 1.5
		point_control.border_color = Color.BLACK
		
		point_control._ready()

		point_control.position = point_position - point_control.size / 2
		point_control.name = \"Point%d\" % i

		point_control.point_hovered.connect(_on_point_hovered.bind(i))
		point_control.point_unhovered.connect(_on_point_unhovered)

		accuracy_chart_points.add_child(point_control)

func _clear_chart():
	accuracy_chart_line.points = []
	_clear_points()
	if tooltip_label:
		tooltip_label.visible = false

func _clear_points():
	for child in accuracy_chart_points.get_children():
		if child.has_method(\"point_hovered\"):
			child.point_hovered.disconnect(_on_point_hovered)
		if child.has_method(\"point_unhovered\"):
			child.point_unhovered.disconnect(_on_point_unhovered)
		child.queue_free()

func _on_point_hovered(global_pos: Vector2, tooltip_text: String, index: int):
	if tooltip_label:
		tooltip_label.text = tooltip_text
		tooltip_label.visible = true
		var local_pos = accuracy_chart_points.to_local(global_pos)
		tooltip_label.position = local_pos + Vector2(-tooltip_label.size.x / 2, -tooltip_label.size.y - 15) 

func _on_point_unhovered():
	if tooltip_label:
		tooltip_label.visible = false

func _on_resized():
	# Вызывается при изменении размера родительского элемента
	update_chart()
"

[node name="AccuracyChart" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_usftd")
